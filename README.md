# QEMU for Xilinx Microblaze

Due to Xilinx document is out of date for newer version of Vitis. It usually not easy to set up QEMU for Microblaze easily. This repo supplies a tutorial how to build it and has been tested on Vivado 2024.2.

# Why Use QEMU to Run MicroBlaze?
QEMU (Quick Emulator) is an open-source emulator that supports multiple CPU architectures, including Xilinx MicroBlaze. When developing MicroBlaze applications, using QEMU for emulation offers several advantages:
**1. Develop Without Hardware, More Convenient**
The MicroBlaze processor typically runs on FPGAs (such as Xilinx 7 Series or UltraScale+), but real hardware can be:
- Expensive (requires an FPGA evaluation board)
- Difficult to debug (requires a JTAG connection)
- Resource-intensive (occupying FPGA resources)

QEMU provides a purely software-based environment, allowing you to develop and test MicroBlaze code on a PC without needing actual FPGA hardware.

**2. Faster Debugging, Saves Time**
Running MicroBlaze on real FPGA hardware requires:

- Re-synthesizing and implementing the design for every change
- Flashing the FPGA, which can be time-consuming

With QEMU:

- Run code instantly, no need for FPGA flashing
- Supports remote debugging with GDB
- Allows snapshots to restore simulation states

Significantly improves development efficiency!

**3. Compatible with Xilinx SDK/Vitis Tools**
QEMU provides MicroBlaze instruction set simulation, which enables:

- Running ELF files generated by Xilinx SDK/Vitis
- Testing embedded applications (e.g., FreeRTOS, Linux Kernel)

# How to build the environment of QEMU for Microblaze
Basically reference [1] should be followed.

1. Run the following commands [1]
```shell
git clone git://github.com/Xilinx/qemu.git
cd qemu
git checkout tags/xilinx_v2024.2
sudo apt install libglib2.0-dev libgcrypt20-dev zlib1g-dev autoconf automake libtool bison flex libpixman-1-dev
git submodule update --init dtc
mkdir build
cd build
../configure --target-list="aarch64-softmmu,microblazeel-softmmu" --enable-fdt --disable-kvm --disable-xen --enable-gcrypt
make -j4
```

2. Create the block design using Vivado (in Tcl)
```shell
source design_1.tcl
```
![](img/block_design.png)

Do every before you can export hardware and launch Vitis

3. Create application using Vitis
- Create Platform Component
- Create **"**Hello World** and **Peripheral Test** applications from **Embedded Software Examples**
- Build elf files
  
4. Create device tree (DTB)
Clone the repo **device-tree-xlnx**
```shell
git clone https://github.com/Xilinx/device-tree-xlnx.git
git checkout tags/xilinx_v2024.2
```
Follow the description in [3], run command `xsct` in terminal and run the following commands
```shell
hsi open_hw_design design_1_wrapper.xsa
hsi set_repo_path <PATH TO device-tree-xlnx>
hsi create_sw_design device-tree -os device_tree -proc microblaze_0
hsi generate_target -dir my_dts/
```

Now a folder named **my_dts** will be created with the following files:
```shell
$ ls my_dts/
device-tree.mss  include  pl.dtsi system-top.dts
```

> NOTE: there is another folder in Xilinx installation path "Xilinx/Vitis/2024.2/data/system-device-tree-xlnx", but it does not work. Always out errors:
> ```shell
> ERROR: [Hsi 55-1594] Core device_tree of version  not found in repositories
> ERROR: [Hsi 55-1447] Error: running create_sw_design.
> ERROR: [Common 17-39] 'hsi::create_sw_design' failed due to earlier errors.
> ```

Create DTB
```shell
cd my_dts
gcc -I my_dts -E -nostdinc -I include -undef -D__DTS__ -x assembler-with-cpp -o system.dts system-top.dts
dtc -I dts -O dtb -o system.dtb system.dts
```

You can also verify the generated DTB file by converting it back to DTS. The genered DTS should be exactly the same as system-top.dts.

```shell
dtc -I dtb -O dts -o system.dts system.dtb
```

5. Run QEMU
```shell
qemu-system-microblazeel -M microblaze-fdt -serial mon:stdio -display none -kernel peripheral_tests.elf -dtb my_dts/system.dtb
```
Make sure the paths of **qemu-system-microblazeel**, **peripheral_tests.elf**, **system.dtb** are correct.

You should see the following output if everything works correctly
```shell
$ qemu-system-microblazeel -M microblaze-fdt-plnx -serial mon:stdio -display none -kernel hello_world.elf -dtb my_dts/system.dtb
Hello World
Successfully ran Hello World application

$ qemu-system-microblazeel -M microblaze-fdt-plnx -serial mon:stdio -display none -kernel peripheral_tests.elf -dtb my_dts/system.dtb
---Entering main---

Running IntcSelfTestExample for axi_intc_0 ... 
IntcSelfTestExample PASSED 

Running GpioOutputExample for axi_gpio_0 ... 
GpioOutputExample PASSED 

Running IicSelfTestExample for axi_iic_0 ... 
IicSelfTestExample FAILED 
---Exiting main---
```

Pree `ctrl+a` and then `x` to quit.




# Reference
[1] [Building and Running QEMU from Source Code](https://xilinx-wiki.atlassian.net/wiki/spaces/A/pages/822312999/Building+and+Running+QEMU+from+Source+Code)
[2] [Debugging Standalone Application on Microblaze using QEMU](https://xilinx-wiki.atlassian.net/wiki/x/9YIfAQ)
[3] [Build Device Tree Blob](https://xilinx-wiki.atlassian.net/wiki/spaces/A/pages/18842279/Build+Device+Tree+Blob)